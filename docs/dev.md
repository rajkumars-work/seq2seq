# Development

_This is the standard instruction from the library template. It should be
updated with instructions specific to this library._

## Setup development

- [Installing and managing Python](https://backstage.spotify.net/docs/python/dev/install/)

Create a new virtual environment with for your supported Python version (minimum of 3.9).
Within that virtualenv:

```shell
$ pip install --index-url https://artifactory.spotify.net/artifactory/api/pypi/pypi/simple -e ".[dev]"
```

This will install development dependencies, followed by installing this package
itself as "[editable]".

### compiling dependencies

For more reproducible builds on CI/CD, coglib can
generate fully specified requirements generated by [pip-compile]. This generates
requirements files specific to each environment/Python version supported, which
are then used for the `tox` envs (see below).

To update the compiled requirements (e.g., after adding or upgrading a dependency)
simply run

```shell
$ tox run -m requirements
```

## Run tests

Tests can be invoked in two ways: `pytest` and `tox`.

### Run tests via `pytest`

Pytest is the recommended test runner framework and coverage can measure the
test coverage. The default pytest config is defined in `pyproject.toml`. [More
information about can be found in the Python documentation][pytest-doc].

```sh
# for all tests
(env) $ pytest tests/

# for one module of tests
(env) $ pytest tests/test_main.py

# for one specific test
(env) $ pytest tests/test_main.py::test_return_state
```

### Run tests via `tox`

[Tox] is a tool to automate and standardize tests and test environments. It is
run in CI with the _[pythonBackend]_ and _[pythonLibrary]_ build templates.

A test environment could be based on python versions, or could be specific to
documentation, or whatever else. See `tox.ini` for examples.

```sh
# run all environments
$ tox

# run a specific environment
$ tox -e py37
```

## Code styling

This library comes with pre-configured dev dependencies:

- [ruff] formating, code styling and linting
- [mypy] type checking

These can be checked with the tox environments

```sh
$ tox -e lint,lint-format,lint-types
```

By default, these will only flag code issues; running `tox -e format` will
automatically try to correct them.

## Release a new version

Tingle will release a new version to internal PyPI (and Debian if configured in
`build-info.yaml`) upon merge to the Master branch. Tingle _will_ fail to
upload the package if the package's version is not updated (often, you don't
always want a new release when merging to master).

## Updating the version

Tingle _will not_ automatically bump the version when merging to Master.
Therefore, project owners must bump the version themselves when ready to make a
new release.

The version is specified in `src/coglib/__init__.py`
and can either be edited manually or the version can be bumped with a tools as
[bump2version]:

```shell
$ bump2version --current-version 0.0.1 PART src/coglib/__init__.py
```

`--current-version` should be the current version of the tool, and `PART` is
the part to increase, i.e., `major`, `minor`, or `patch`.

The `--tag` flag is not recommended to use, as Tingle will create a tag for the
commit when building and uploading the library.

It is recommended to install bump2version with pipx. The [central Python
documentation has a section on pipx][pipx-doc].


<!-- links -->
[bs-create]: https://backstage.spotify.net/create-component/python-library/
[cookiecutter]: https://github.com/cookiecutter/cookiecutter/
[editable]: https://pip.pypa.io/en/stable/reference/pip_install/#editable-installs/
[pytest-doc]: https://backstage.spotify.net/docs/python/tools/pytest-coverage/
[Tox]: https://tox.readthedocs.io/en/latest/
[pythonBackend]: https://backstage.spotify.net/docs/tingle/tingle-templates/python-backend/
[pythonLibrary]: https://backstage.spotify.net/docs/tingle/tingle-templates/python-library/
[bump2version]: https://github.com/c4urself/bump2version
[pipx-doc]: https://backstage.spotify.net/docs/python/dev/pipx/
[ruff]: https://backstage.spotify.net/docs/python/tools/advanced/ruff
[mypy]: https://mypy.readthedocs.io/en/stable/
[pip-compile]: https://github.com/jazzband/pip-tools
